<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hidden Treasure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0e0e0e;
      color: #fff;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
    }

    .box {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    input, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }

    input {
      background: #111;
      color: #fff;
    }

    button {
      background: #3b82f6;
      color: #fff;
      cursor: pointer;
    }

    button.secondary { background: #555; }
    button.danger { background: #dc2626; }

    .hidden { display: none; }

    #habboAvatar {
      image-rendering: pixelated;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <h1>Hidden Treasure</h1>

  <!-- VERIFY -->
  <div class="box">
    <input id="habboName" placeholder="Habbo name" />
    <button id="startVerifyBtn">Get verification code</button>
    <div id="phraseBox"></div>
    <button id="copyBtn" class="secondary hidden">Copy code</button>
    <button id="checkVerifyBtn" class="secondary hidden">I've updated my motto</button>
    <div id="verifyStatus"></div>
  </div>

  <!-- AVATAR -->
  <div class="box hidden" id="avatarBox" style="text-align:center;">
    <img id="habboAvatar" />
    <div id="habboNameLabel"></div>
  </div>

  <!-- REDEEM -->
  <div class="box hidden" id="redeemBox">
    <input id="codeInput" placeholder="Enter code" />
    <button id="redeemBtn">Redeem</button>
    <div id="redeemMessage"></div>
  </div>

  <!-- LOGOUT -->
  <div class="box hidden" id="logoutBox">
    <button id="logoutBtn" class="danger">Log out / switch Habbo</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://neqhpxtsnsfutgsmydlb.supabase.co";
    const SUPABASE_KEY = "sb_publishable_iL7ce1l87I02ZKsIsrkVOA_4rWnFoBR";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const habboName = document.getElementById("habboName");
    const startVerifyBtn = document.getElementById("startVerifyBtn");
    const checkVerifyBtn = document.getElementById("checkVerifyBtn");
    const copyBtn = document.getElementById("copyBtn");
    const phraseBox = document.getElementById("phraseBox");
    const verifyStatus = document.getElementById("verifyStatus");

    const avatarBox = document.getElementById("avatarBox");
    const habboAvatar = document.getElementById("habboAvatar");
    const habboNameLabel = document.getElementById("habboNameLabel");

    const redeemBox = document.getElementById("redeemBox");
    const redeemBtn = document.getElementById("redeemBtn");
    const redeemMessage = document.getElementById("redeemMessage");
    const codeInput = document.getElementById("codeInput");

    const logoutBox = document.getElementById("logoutBox");
    const logoutBtn = document.getElementById("logoutBtn");

    async function ensureSession() {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        await supabaseClient.auth.signInAnonymously();
      }
    }

    async function showAvatar() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return;

      const { data: profile } = await supabaseClient
        .schema("public")
        .from("users")
        .select("habbo_name, habbo_figure, verified")
        .eq("user_id", user.id)
        .maybeSingle();

      if (!profile || !profile.verified || !profile.habbo_figure) return;

      habboAvatar.src =
        `https://www.habbo.com/habbo-imaging/avatarimage?figure=${profile.habbo_figure}&direction=2&head_direction=2&gesture=sml&size=l&action=std`;

      habboNameLabel.textContent = profile.habbo_name;
      avatarBox.classList.remove("hidden");
      redeemBox.classList.remove("hidden");
      logoutBox.classList.remove("hidden");
    }

    async function callFunction(name, body = {}) {
      const session = (await supabaseClient.auth.getSession()).data.session;
      return fetch(`${SUPABASE_URL}/functions/v1/${name}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${session.access_token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      }).then(r => r.json());
    }

    startVerifyBtn.onclick = async () => {
      await ensureSession();
      const res = await callFunction("verify-habbo", {
        habbo_name: habboName.value.trim()
      });

      phraseBox.innerHTML = `<strong>${res.phrase}</strong>`;
      copyBtn.classList.remove("hidden");
      checkVerifyBtn.classList.remove("hidden");
    };

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(phraseBox.innerText);
    };

    checkVerifyBtn.onclick = async () => {
      verifyStatus.textContent = "Checking...";
      const res = await callFunction("check-habbo-motto");
      if (res.verified) {
        verifyStatus.textContent = "Verified!";
        showAvatar();
      } else {
        verifyStatus.textContent = "Code not found yet.";
      }
    };

    redeemBtn.onclick = async () => {
      const { data } = await supabaseClient.rpc("redeem_code", {
        p_code_string: codeInput.value.trim()
      });
      redeemMessage.textContent = data?.message;
    };

    logoutBtn.onclick = async () => {
      await supabaseClient.auth.signOut();
      location.reload();
    };

    document.addEventListener("DOMContentLoaded", async () => {
      await ensureSession();
      showAvatar();
    });
  </script>

</body>
</html>
