<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hidden Treasure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0e0e0e;
      color: #ffffff;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
    }

    h1, h2 {
      text-align: center;
    }

    input, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
    }

    input {
      background: #1e1e1e;
      color: #fff;
    }

    button {
      background: #3b82f6;
      color: white;
      cursor: pointer;
    }

    button.secondary {
      background: #555;
    }

    button.danger {
      background: #dc2626;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .box {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #1e1e1e;
      border-radius: 6px;
    }

    .message {
      margin-top: 0.75rem;
      min-height: 2rem;
    }

    .success { color: #22c55e; }
    .error { color: #ef4444; }

    .hidden { display: none; }

    #habboAvatar {
      image-rendering: pixelated;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <h1>Hidden Treasure</h1>

  <!-- HABBO VERIFICATION -->
  <div class="box" id="verifyBox">
    <h2>Verify your Habbo</h2>

    <input
      id="habboName"
      type="text"
      placeholder="Habbo username"
      autocomplete="off"
    />

    <button id="startVerifyBtn">Get verification code</button>

    <div id="phraseBox" class="message"></div>

    <button id="copyBtn" class="secondary hidden">Copy code</button>

    <button id="checkVerifyBtn" class="secondary hidden">
      I’ve updated my motto
    </button>

    <div id="verifyStatus" class="message"></div>

    <!-- AVATAR -->
    <div id="avatarBox" class="hidden" style="text-align:center;">
  <img
    id="habboAvatar"
    alt="Habbo avatar"
    style="image-rendering: pixelated;"
  />
  <div id="habboNameLabel"></div>
</div>
  </div>

  <!-- CODE REDEMPTION -->
  <div class="box hidden" id="redeemBox">
    <h2>Redeem Code</h2>

    <input
      id="codeInput"
      type="text"
      placeholder="Enter code"
      autocomplete="off"
    />

    <button id="redeemBtn">Redeem</button>

    <div id="redeemMessage" class="message"></div>
  </div>

  <!-- LOG OUT -->
  <div class="box hidden" id="logoutBox">
    <button id="logoutBtn" class="danger">
      Log out / switch Habbo
    </button>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'https://neqhpxtsnsfutgsmydlb.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_iL7ce1l87I02ZKsIsrkVOA_4rWnFoBR';

    const supabaseClient = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    const habboNameInput = document.getElementById('habboName');
    const startVerifyBtn = document.getElementById('startVerifyBtn');
    const checkVerifyBtn = document.getElementById('checkVerifyBtn');
    const copyBtn = document.getElementById('copyBtn');
    const phraseBox = document.getElementById('phraseBox');
    const verifyStatus = document.getElementById('verifyStatus');

    const avatarBox = document.getElementById('avatarBox');
    const habboAvatar = document.getElementById('habboAvatar');
    const habboNameLabel = document.getElementById('habboNameLabel');

    const redeemBox = document.getElementById('redeemBox');
    const codeInput = document.getElementById('codeInput');
    const redeemBtn = document.getElementById('redeemBtn');
    const redeemMessage = document.getElementById('redeemMessage');

    const logoutBox = document.getElementById('logoutBox');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentPhrase = '';

    async function ensureSession() {
      await supabaseClient.auth.signInAnonymously();
    }

    async function callFunction(name, body) {
      const session = (await supabaseClient.auth.getSession()).data.session;

      return fetch(`${SUPABASE_URL}/functions/v1/${name}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        body: JSON.stringify(body)
      }).then(res => res.json());
    }

    startVerifyBtn.onclick = async () => {
      const habboName = habboNameInput.value.trim();
      if (!habboName) return;

      await ensureSession();

      phraseBox.textContent = 'Generating code…';
      verifyStatus.textContent = '';
      avatarBox.classList.add('hidden');

      const res = await callFunction('verify-habbo', {
        habbo_name: habboName
      });

      if (res.phrase) {
        currentPhrase = res.phrase;
        phraseBox.innerHTML =
          `Put this in your Habbo motto:<br><strong>${res.phrase}</strong>`;
        copyBtn.classList.remove('hidden');
        checkVerifyBtn.classList.remove('hidden');
      } else {
        phraseBox.textContent = 'Error generating code.';
      }
    };

    copyBtn.onclick = async () => {
      await navigator.clipboard.writeText(currentPhrase);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy code', 1500);
    };

    checkVerifyBtn.onclick = async () => {
      verifyStatus.textContent = 'Checking motto…';

      const res = await callFunction('check-habbo-motto', {});

      if (res.verified) {
        verifyStatus.textContent = '✔ Habbo verified!';
        verifyStatus.className = 'message success';

        redeemBox.classList.remove('hidden');
        logoutBox.classList.remove('hidden');
  		showAvatar();

const { data: user, error } = await supabaseClient
  .schema('public')
  .from('users')
  .select('habbo_name, habbo_figure')
  .eq('id', (await supabaseClient.auth.getUser()).data.user.id)
  .maybeSingle();

if (error) {
  console.error('User fetch error:', error);
  return;
}

if (user?.habbo_figure) {
  const avatarUrl =
    `https://www.habbo.com/habbo-imaging/avatarimage` +
    `?figure=${user.habbo_figure}` +
    `&direction=2&head_direction=2&gesture=sml&size=l&action=std`;

  habboAvatar.src = avatarUrl;
  habboNameLabel.textContent = user.habbo_name;
  avatarBox.classList.remove('hidden');
}

      } else {
        verifyStatus.textContent =
          'Code not found yet. Try again in a moment.';
        verifyStatus.className = 'message error';
      }
    };

    redeemBtn.onclick = async () => {
      const code = codeInput.value.trim();
      if (!code) return;

      await ensureSession();

      redeemMessage.textContent = 'Checking code…';

      const { data: user, error } = await supabaseClient
  .schema('public')
  .from('users')
  .select('habbo_name, habbo_figure')
  .eq('id', (await supabaseClient.auth.getUser()).data.user.id)
  .maybeSingle();

if (error) {
  console.error('User fetch error:', error);
  return;
}

if (!user) {
  console.log('User row not created yet, retrying...');
  setTimeout(checkVerifyBtn.onclick, 500);
  return;
}

if (user.habbo_figure) {
  const avatarUrl =
    `https://www.habbo.com/habbo-imaging/avatarimage` +
    `?figure=${user.habbo_figure}` +
    `&direction=2&head_direction=2&gesture=sml&size=l&action=std`;

  habboAvatar.src = avatarUrl;
  habboNameLabel.textContent = user.habbo_name;
  avatarBox.classList.remove('hidden');
}

      redeemMessage.textContent = error
        ? 'Something went wrong.'
        : data.message;
    };

    logoutBtn.onclick = async () => {
      await supabaseClient.auth.signOut();
      localStorage.clear();
      location.reload();
    };
    
      async function showAvatar() {
    const {
      data: { user: authUser }
    } = await supabaseClient.auth.getUser();

    if (!authUser) return;

    const { data: profile, error } = await supabaseClient
      .schema("public")
      .from("users")
      .select("habbo_name, habbo_figure, verified")
      .eq("id", authUser.id)
      .maybeSingle();

    if (error || !profile) {
      console.error("Profile fetch failed", error);
      return;
    }

    if (!profile.verified || !profile.habbo_figure) {
      console.warn("Profile not verified or missing figure", profile);
      return;
    }

    const avatarUrl =
      `https://www.habbo.com/habbo-imaging/avatarimage` +
      `?figure=${profile.habbo_figure}` +
      `&direction=2&head_direction=2&gesture=sml&size=l&action=std`;

    const img = document.getElementById("habboAvatar");
    const box = document.getElementById("avatarBox");
    const nameLabel = document.getElementById("habboNameLabel");

    img.onload = () => {
      box.classList.remove("hidden");
    };

    img.onerror = () => {
      console.error("Avatar image failed to load", avatarUrl);
    };

    img.src = avatarUrl;
    nameLabel.textContent = profile.habbo_name;
  }
  
  document.addEventListener("DOMContentLoaded", async () => {
  await supabaseClient.auth.signInAnonymously();
  showAvatar();
});

  </script>

</body>
</html>
